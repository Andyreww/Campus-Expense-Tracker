<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nooksii - Roadmap</title>
    
    <!-- External Stylesheet -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Google Fonts (Cafe Vibe) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Lato:wght@400;700&family=Nunito:wght@700;900&family=Special+Elite&family=Patrick+Hand&display=swap" rel="stylesheet">
    
</head>
<body class="roadmap-body">

    <!-- Simplified Header -->
    <header id="main-header" class="header-scrolled">
        <div class="container">
            <a href="index.html" class="logo-link">
                <h1 class="logo-text">
                    <svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20.92,8.34a7.42,7.42,0,0,0-9.61-6.19,7.4,7.4,0,0,0-5.13,5.13A7.42,7.42,0,0,0,12.37,20.9a1.49,1.49,0,0,0,2.1-.45,1.5,1.5,0,0,0-.45-2.1,4.43,4.43,0,0,1-3-5.49,4.42,4.42,0,0,1,5.49-3,4.43,4.43,0,0,1,3,5.49,1.5,1.5,0,0,0,.45,2.1,1.49,1.49,0,0,0,2.1-.45A7.42,7.42,0,0,0,20.92,8.34Z"/>
                    </svg>
                    Nooksii
                </h1>
            </a>
            <a href="dashboard.html" id="dashboard-button" class="desktop-cta-button">Go to Dashboard</a>
        </div>
    </header>

    <main>
        <section class="roadmap-section">
            <div class="container">
                <div class="roadmap-board">
                    <div class="section-header">
                         <h2 class="section-title">Help Us Build!</h2>
                         <p class="section-subtitle">Vote on which town projects you want to see next. Your bells... err, votes... decide our priorities!</p>
                    </div>
                    <div id="poll-list" class="poll-list">
                        <!-- Features are now hardcoded in the HTML -->
                        <!-- The script will fetch vote counts and update these elements -->
                        
                        <div class="poll-item" data-poll-id="monthly-questionnaire">
                            <div class="poll-content">
                                <h3 class="poll-title">Monthly Questionnaire</h3>
                                <p class="poll-description">Answer fun monthly questions and see how your anonymous answers compare to others on campus.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg></button></div>
                        </div>
                        
                        <div class="poll-item" data-poll-id="achievement-system">
                            <div class="poll-content">
                                <h3 class="poll-title">Achievement System</h3>
                                <p class="poll-description">Unlock badges and rewards for logging consistently, exploring new places, and managing your funds.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="low-balance-alerts">
                            <div class="poll-content">
                                <h3 class="poll-title">Low Balance Alerts</h3>
                                <p class="poll-description">Get a friendly notification when your dining dollars or meal swipes are running low so you're never caught off guard.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="smart-predictive-items">
                            <div class="poll-content">
                                <h3 class="poll-title">Smart Predictive Items</h3>
                                <p class="poll-description">Nooksii will learn your routine and predict items you might be buying based on the time and day.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg></button></div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Built by students, for students.</p>
        <p class="footer-subtext">Let's get this bread üçû</p>
    </footer>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import the central firebaseReady promise from auth.js
        import { firebaseReady } from './auth.js';
        // Import necessary Firestore functions
        import { 
            getFirestore, collection, getDocs, doc, getDoc,
            runTransaction, arrayUnion, serverTimestamp, onSnapshot,
            deleteDoc, arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase to be ready
            const { auth, db } = await firebaseReady;
            const pollListContainer = document.getElementById('poll-list');
            let currentUser = null; 
            let userVotes = {};
            let userVotesListener = null; // To hold the listener unsubscribe function

            /**
             * Updates the UI for a single poll item with data from Firestore.
             */
            function updatePollUI(pollId, data) {
                const pollElement = document.querySelector(`.poll-item[data-poll-id="${pollId}"]`);
                if (!pollElement) return;

                const totalVotes = data.voteCount || 0;
                const voteCountEl = pollElement.querySelector('.poll-vote-count');
                const progressFillEl = pollElement.querySelector('.poll-progress-fill');
                const votersEl = pollElement.querySelector('.poll-voters');

                voteCountEl.textContent = `${totalVotes} Votes`;

                const allVoteCounts = Array.from(document.querySelectorAll('.poll-vote-count')).map(el => parseInt(el.textContent) || 0);
                const maxVotes = Math.max(50, ...allVoteCounts); 
                const progress = maxVotes > 0 ? Math.min((totalVotes / maxVotes) * 100, 100) : 0;
                progressFillEl.style.width = `${progress}%`;

                const voters = data.recentVoters || [];
                let votersHTML = voters.slice(-5).reverse().map(voter => 
                    `<img src="${voter.photoURL || `https://i.pravatar.cc/40?u=${voter.uid}`}" alt="${voter.displayName}" class="voter-avatar" title="${voter.displayName}" onerror="this.onerror=null;this.src='https://i.pravatar.cc/40';">`
                ).join('');

                if (totalVotes > 5) {
                    votersHTML += `<div class="voter-avatar more-votes">+${totalVotes - 5}</div>`;
                }
                votersEl.innerHTML = votersHTML;
            }

            /**
             * Updates the state of all vote buttons based on the user's votes.
             */
            function updateUserVoteStatus() {
                const allPollItems = document.querySelectorAll('.poll-item');
                allPollItems.forEach(item => {
                    const pollId = item.dataset.pollId;
                    const button = item.querySelector('.poll-vote-button');
                    const hasVoted = userVotes[pollId] || false;
                    
                    button.classList.toggle('voted', hasVoted);
                    button.disabled = false; // Always enable the button first
                    if(hasVoted) {
                        // If voted, the button becomes an "unvote" button
                    }
                });
            }

            /**
             * Handles the logic when a user clicks the vote button.
             */
            async function handleVote(e) {
                if (!e.target.closest('.poll-vote-button')) return;

                if (!currentUser) {
                    window.location.href = 'login.html?redirect=roadmap.html';
                    return;
                }

                const button = e.target.closest('.poll-vote-button');
                const pollItem = e.target.closest('.poll-item');
                const pollId = pollItem.dataset.pollId;

                button.disabled = true; // Disable during transaction
                
                const hasVoted = userVotes[pollId] || false;

                try {
                    const pollRef = doc(db, "featurePolls", pollId);
                    const userVoteRef = doc(db, "users", currentUser.uid, "featureVotes", pollId);

                    await runTransaction(db, async (transaction) => {
                        const pollDoc = await transaction.get(pollRef);
                        
                        if (!pollDoc.exists() && !hasVoted) {
                            // If the poll doc doesn't exist and we are voting for it
                             const newVoter = {
                                uid: currentUser.uid,
                                displayName: currentUser.displayName || 'A Villager',
                                photoURL: currentUser.photoURL || null
                            };
                            transaction.set(pollRef, { voteCount: 1, recentVoters: [newVoter] });
                            transaction.set(userVoteRef, { votedAt: serverTimestamp() });
                            return;
                        }

                        if (!pollDoc.exists()) {
                            throw "Poll does not exist!";
                        }

                        let newVoteCount = pollDoc.data().voteCount || 0;
                        const voterInfo = {
                            uid: currentUser.uid,
                            displayName: currentUser.displayName || 'A Villager',
                            photoURL: currentUser.photoURL || null
                        };

                        if (hasVoted) {
                            // --- Unvote Logic ---
                            newVoteCount = Math.max(0, newVoteCount - 1);
                            transaction.update(pollRef, {
                                voteCount: newVoteCount,
                                recentVoters: arrayRemove(voterInfo)
                            });
                            transaction.delete(userVoteRef);
                        } else {
                            // --- Vote Logic ---
                            newVoteCount += 1;
                            transaction.update(pollRef, { 
                                voteCount: newVoteCount,
                                recentVoters: arrayUnion(voterInfo)
                            });
                            transaction.set(userVoteRef, { votedAt: serverTimestamp() });
                        }
                    });

                } catch (error) {
                    console.error("Transaction failed: ", error);
                    alert("There was an error changing your vote. Please try again.");
                } finally {
                    button.disabled = false; // Re-enable after transaction
                }
            }

            // --- Initial Load Logic ---
            
            // 1. Set up real-time listeners for each poll
            const allPollItems = document.querySelectorAll('.poll-item');
            allPollItems.forEach(item => {
                const pollId = item.dataset.pollId;
                const pollRef = doc(db, "featurePolls", pollId);
                onSnapshot(pollRef, (doc) => {
                    if (doc.exists()) {
                        updatePollUI(pollId, doc.data());
                    }
                }, (error) => {
                    console.error(`Error listening to poll ${pollId}:`, error);
                });
            });

            // 2. Set up the auth listener
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                
                // If a listener for a previous user exists, unsubscribe from it
                if (userVotesListener) {
                    userVotesListener(); 
                }

                if (user) {
                    // Set up a new real-time listener for the current user's votes
                    const votesRef = collection(db, 'users', user.uid, 'featureVotes');
                    userVotesListener = onSnapshot(votesRef, (snapshot) => {
                        const newUserVotes = {};
                        snapshot.forEach(doc => {
                            newUserVotes[doc.id] = true;
                        });
                        userVotes = newUserVotes;
                        updateUserVoteStatus();
                    });
                } else {
                    // If user logs out, clear votes and update UI
                    userVotes = {};
                    updateUserVoteStatus();
                }
            });

            pollListContainer.addEventListener('click', handleVote);
        });
    </script>
</body>
</html>
