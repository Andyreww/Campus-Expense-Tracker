<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nooksii - Roadmap</title>
    
    <!-- External Stylesheet -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Google Fonts (Cafe Vibe) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Lato:wght@400;700&family=Nunito:wght@700;900&family=Special+Elite&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <style>
        /* This style block creates the responsive grid layout */
        @media (min-width: 768px) {
            .poll-list {
                /* Switched to flexbox for better wrapping */
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 2rem 1.5rem; /* Vertical and horizontal gap */
            }
            .poll-item {
                /* Each item takes up half the space on tablets */
                width: calc(50% - 1rem);
            }
        }
        @media (min-width: 1024px) {
            .poll-item {
                 /* Each item takes up a third of the space on desktops */
                width: calc(33.333% - 1rem);
            }
        }
        /* Style for the new clarification text */
        .section-clarification {
            font-family: 'Lato', sans-serif;
            color: #6c757d; /* A slightly muted, modern color */
            font-size: 1.1rem;
            margin-top: 0.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem; /* Add some padding for smaller screens */
        }
    </style>
</head>
<body class="roadmap-body">

    <!-- Simplified Header -->
    <header id="main-header" class="header-scrolled">
        <div class="container">
            <a href="index.html" class="logo-link">
                <h1 class="logo-text">
                    <svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20.92,8.34a7.42,7.42,0,0,0-9.61-6.19,7.4,7.4,0,0,0-5.13,5.13A7.42,7.42,0,0,0,12.37,20.9a1.49,1.49,0,0,0,2.1-.45,1.5,1.5,0,0,0-.45-2.1,4.43,4.43,0,0,1-3-5.49,4.42,4.42,0,0,1,5.49-3,4.43,4.43,0,0,1,3,5.49,1.5,1.5,0,0,0,.45,2.1,1.49,1.49,0,0,0,2.1-.45A7.42,7.42,0,0,0,20.92,8.34Z"/>
                    </svg>
                    Nooksii
                </h1>
            </a>
            <a href="index.html" id="dashboard-button" class="desktop-cta-button">Back to Main Page</a>
        </div>
    </header>

    <main>
        <section class="roadmap-section">
            <div class="container">
                <div class="roadmap-board">
                    <div class="section-header">
                         <h2 class="section-title">Help Us Make Nooksii Better :)</h2>
                         <p class="section-subtitle">Because ‚Äústudent built‚Äù means you decide what‚Äôs next.</p>
                         <!-- This is the new clarification text -->
                         <p class="section-clarification">Vote on the features you'd like to see on Nooksii. The 3 top voted ideas get prioritized first!</p>
                    </div>
                    <div id="poll-list" class="poll-list">
                        <!-- Features are now hardcoded in the HTML -->
                        
                        <div class="poll-item" data-poll-id="monthly-questionnaire">
                            <div class="poll-content">
                                <h3 class="poll-title">Monthly Questionnaire</h3>
                                <p class="poll-description">Answer fun monthly questions and see how your anonymous answers compare to others on campus.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>
                        
                        <div class="poll-item" data-poll-id="achievement-system">
                            <div class="poll-content">
                                <h3 class="poll-title">Achievement System</h3>
                                <p class="poll-description">Unlock badges and rewards for logging consistently, exploring new places, and managing your funds.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="low-balance-alerts">
                            <div class="poll-content">
                                <h3 class="poll-title">Low Balance Alerts</h3>
                                <p class="poll-description">Get notified when your balance is low, so you're never stuck without a meal swipe or funds.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="smart-predictive-items">
                            <div class="poll-content">
                                <h3 class="poll-title">Smart Predictive Items</h3>
                                <p class="poll-description">Nooksii will learn your routine and predict items you might be buying based on the time and day.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="campus-vibe-check">
                            <div class="poll-content">
                                <h3 class="poll-title">Monthly Trending Picks</h3>
                                <p class="poll-description">See what's trending on campus ‚Äî from songs to food to study spots, refreshed every month.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="flex-fairy">
                            <div class="poll-content">
                                <h3 class="poll-title">Flex Fairy</h3>
                                <p class="poll-description">A shared space where students can post requests for help if they're running low on expenses and a person with enough funds can help buy you food!</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="squad-spending">
                            <div class="poll-content">
                                <h3 class="poll-title">Friend Spending Comparison (Opt-in)</h3>
                                <p class="poll-description">Opt-in to friendly budget battles ‚Äî compare spending with friends and see who's saving the most.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="club-badges">
                            <div class="poll-content">
                                <h3 class="poll-title">Club & Org Badges</h3>
                                <p class="poll-description">Rep your crew! Display special badges on your profile for the clubs and organizations you're a part of.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="custom-name-colors">
                            <div class="poll-content">
                                <h3 class="poll-title">Allow Users to Add Color to Their Names</h3>
                                <p class="poll-description">Personalize your profile with custom name colors and stand out on the leaderboard.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="spending-coach">
                            <div class="poll-content">
                                <h3 class="poll-title">Advice on Excessive Spending</h3>
                                <p class="poll-description">Get smart, friendly tips when your spending gets wild, no judgment, just helpful advice.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="campus-spending-trends">
                            <div class="poll-content">
                                <h3 class="poll-title">Campus Spending Trends</h3>
                                <p class="poll-description">See anonymous campus-wide trends like top food items and busiest spots.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="logging-reminders">
                            <div class="poll-content">
                                <h3 class="poll-title">Reminders</h3>
                                <p class="poll-description">Set gentle reminders to log purchases or check your balance to keep your streak strong.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <div class="poll-item" data-poll-id="leaderboard-2-0">
                            <div class="poll-content">
                                <h3 class="poll-title">Change the Design of the Internal Leaderboard</h3>
                                <p class="poll-description">A total redesign of the leaderboard ‚Äî more visual, rewarding, and fun to use.</p>
                                <div class="poll-progress-bar"><div class="poll-progress-fill" style="width: 0%;"></div><span class="poll-vote-count">0 Votes</span></div>
                                <div class="poll-voters"></div>
                            </div>
                            <div class="poll-action" style="display: none;"><button class="poll-vote-button"><svg class="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg><svg class="x-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
                        </div>

                        <!-- New "Suggest a Feature" Card -->
                        <div class="poll-item poll-item-suggestion">
                           <div class="suggestion-content">
                               <div class="suggestion-icon">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>
                               </div>
                               <h3 class="suggestion-title">Have an Idea?</h3>
                               <p class="suggestion-text">Think something's missing? Let us know! We're always looking for new projects to build.</p>
                               <a href="mailto:ajangulo8@gmail.com?subject=Nooksii Feature Idea" class="suggestion-button">Suggest a Feature</a>
                           </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Built by students, for students.</p>
        <p class="footer-subtext">Let's get this bread üçû</p>
    </footer>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import the central firebaseReady promise from auth.js
        import { firebaseReady } from './auth.js';
        // Import necessary Firestore functions
        import { 
            getFirestore, collection, doc,
            runTransaction, arrayUnion, serverTimestamp, onSnapshot,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // Import modular auth listener
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase to be ready and resolve actual instances
            const services = await firebaseReady;
            const auth = await services.auth;
            const db = await services.db;
            const pollListContainer = document.getElementById('poll-list');
            let currentUser = null; 
            let userVotes = {};
            let userVotesListener = null; // To hold the listener unsubscribe function

            /**
             * Re-orders the poll items in the DOM based on vote counts.
             */
            function sortPollsUI(voteData) {
                const pollItems = Array.from(pollListContainer.querySelectorAll('.poll-item:not(.poll-item-suggestion)'));
                pollItems.sort((a, b) => {
                    const votesA = voteData[a.dataset.pollId]?.voteCount || 0;
                    const votesB = voteData[b.dataset.pollId]?.voteCount || 0;
                    return votesB - votesA; // Sort descending
                });
                // Re-append to the container in the new order
                pollItems.forEach(item => pollListContainer.appendChild(item));
                
                // Always make sure the suggestion card is last
                const suggestionCard = pollListContainer.querySelector('.poll-item-suggestion');
                if (suggestionCard) {
                    pollListContainer.appendChild(suggestionCard);
                }
            }

            /**
             * Updates the UI for a single poll item with data from Firestore.
             */
            function updatePollUI(pollId, data) {
                const pollElement = document.querySelector(`.poll-item[data-poll-id="${pollId}"]`);
                if (!pollElement) return;

                const totalVotes = data.voteCount || 0;
                const voteCountEl = pollElement.querySelector('.poll-vote-count');
                const progressFillEl = pollElement.querySelector('.poll-progress-fill');
                const votersEl = pollElement.querySelector('.poll-voters');

                voteCountEl.textContent = `${totalVotes} Votes`;

                const allVoteCounts = Array.from(document.querySelectorAll('.poll-vote-count')).map(el => parseInt(el.textContent) || 0);
                const maxVotes = Math.max(50, ...allVoteCounts, totalVotes); 
                const progress = maxVotes > 0 ? Math.min((totalVotes / maxVotes) * 100, 100) : 0;
                progressFillEl.style.width = `${progress}%`;

                const voters = data.recentVoters || [];
                let votersHTML = voters.slice(-5).reverse().map(voter => 
                    `<img src="${voter.photoURL || `https://i.pravatar.cc/40?u=${voter.uid}`}" alt="${voter.displayName}" class="voter-avatar" title="${voter.displayName}" onerror="this.onerror=null;this.src='https://i.pravatar.cc/40';">`
                ).join('');

                if (totalVotes > 5) {
                    votersHTML += `<div class="voter-avatar more-votes">+${totalVotes - 5}</div>`;
                }
                votersEl.innerHTML = votersHTML;
            }

            /**
             * Updates the state of all vote buttons based on the user's votes.
             */
            function updateUserVoteStatus() {
                const allPollItems = document.querySelectorAll('.poll-item');
                allPollItems.forEach(item => {
                    const pollId = item.dataset.pollId;
                    const button = item.querySelector('.poll-vote-button');
                    if (!button) return;
                    const hasVoted = userVotes[pollId] || false;
                    
                    button.classList.toggle('voted', hasVoted);
                });
            }

            /**
             * Shows or hides all vote buttons based on login status.
             */
            function toggleVoteButtonsVisibility(isLoggedIn) {
                const allPollActions = document.querySelectorAll('.poll-action');
                allPollActions.forEach(action => {
                    action.style.display = isLoggedIn ? 'flex' : 'none';
                });
            }

            /**
             * Handles the logic when a user clicks the vote button.
             */
            async function handleVote(e) {
                const button = e.target.closest('.poll-vote-button');
                if (!button) return;

                if (!currentUser) {
                    window.location.href = 'login.html?redirect=roadmap.html';
                    return;
                }

                const pollItem = button.closest('.poll-item');
                const pollId = pollItem.dataset.pollId;

                button.disabled = true; // Disable during transaction
                
                const hasVoted = userVotes[pollId] || false;

                try {
                    const pollRef = doc(db, "featurePolls", pollId);
                    const userVoteRef = doc(db, "users", currentUser.uid, "featureVotes", pollId);

                    await runTransaction(db, async (transaction) => {
                        const pollDoc = await transaction.get(pollRef);
                        
                        if (hasVoted) {
                            // --- UNVOTE LOGIC ---
                            if (pollDoc.exists()) {
                                const currentVoteCount = pollDoc.data().voteCount || 0;
                                const newVoteCount = Math.max(0, currentVoteCount - 1);
                                
                                const updatedVoters = (pollDoc.data().recentVoters || []).filter(v => v.uid !== currentUser.uid);
                                
                                transaction.update(pollRef, {
                                    voteCount: newVoteCount,
                                    recentVoters: updatedVoters
                                });
                            }
                            // Always delete the user's vote record
                            transaction.delete(userVoteRef);
                        } else {
                            // --- VOTE LOGIC ---
                            const voterInfo = {
                                uid: currentUser.uid,
                                displayName: currentUser.displayName || 'A Villager',
                                photoURL: currentUser.photoURL || null
                            };
                            if (pollDoc.exists()) {
                                const newVoteCount = (pollDoc.data().voteCount || 0) + 1;
                                transaction.update(pollRef, { 
                                    voteCount: newVoteCount,
                                    recentVoters: arrayUnion(voterInfo)
                                });
                            } else {
                                // Create the document if it doesn't exist
                                transaction.set(pollRef, { 
                                    title: pollItem.querySelector('.poll-title').textContent,
                                    description: pollItem.querySelector('.poll-description').textContent,
                                    voteCount: 1, 
                                    recentVoters: [voterInfo] 
                                });
                            }
                            transaction.set(userVoteRef, { votedAt: serverTimestamp() });
                        }
                    });

                } catch (error) {
                    console.error("‚õîÔ∏è Transaction failed! Here is the full error object:", error);
                    alert("There was an error changing your vote. Please check the console for more details.");
                } finally {
                    button.disabled = false; // Re-enable after transaction
                }
            }

            // --- Initial Load Logic ---
            
            // 1. Set up a single real-time listener for the entire polls collection
            const pollsRef = collection(db, "featurePolls");
            onSnapshot(pollsRef, (snapshot) => {
                const voteData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    voteData[doc.id] = data;
                    updatePollUI(doc.id, data);
                });
                sortPollsUI(voteData); // Re-sort the entire list whenever data changes
            }, (error) => {
                console.error("Error listening to polls collection:", error);
            });


            // 2. Set up the auth listener
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                toggleVoteButtonsVisibility(!!user); // Show/hide buttons
                
                if (userVotesListener) {
                    userVotesListener(); 
                }

                if (user) {
                    // If user is logged in, listen for their specific votes
                    const votesRef = collection(db, 'users', user.uid, 'featureVotes');
                    userVotesListener = onSnapshot(votesRef, (snapshot) => {
                        const newUserVotes = {};
                        snapshot.forEach(doc => {
                            newUserVotes[doc.id] = true;
                        });
                        userVotes = newUserVotes;
                        updateUserVoteStatus();
                    }, (error) => {
                        console.error("Error listening to user votes:", error);
                    });
                } else {
                    // If user logs out, clear local vote data and update UI
                    userVotes = {};
                    updateUserVoteStatus();
                }
            });

            pollListContainer.addEventListener('click', handleVote);
        });
    </script>
</body>
</html>
